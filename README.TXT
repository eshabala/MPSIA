Документация к MPSIA (Alert Bot).

Alert bot - модуль оповещения о инцидентах и генерации карточек уведомлений для SIEM Max Patrol и их отправки по списку рассылки. Версия SEIM на которой производилось тестирование: MAXPATROL SIEM 21.0.0.

Alert boot проходит авторизацию без помощи api, используя путь, аналогичный авторизации пользователей с помощью веб интерфейса (post json). После авторизции все запросы выполняются с помощью api. Поддерживается проверка подлинности сертификатов TLS/SSL, но по умолчанию проверка отключена, т.к. Max Patrol SIEM генерирует самоподписанные сертификаты, которые данную проверку не проходят.

Может быть установлен как на отдельный сервер, для удаленного мониторинга по расписанию, так и на рабочую станцию, для обновления списков инцидентов по запросу.

Системные требования:

- python3 (pdfkit, bs4, codecs, jinja2, requests, urllib3)
- nginx/apache2
- wkhtmltopdf

Структура проекта:

/
|-------- templates - папка с шаблонами запросов, карточек, писем. [доступ должен быть ограничен]
|             |-------- html
|             |           |-------- list.html - шаблон списка инцидентов
|             |           |-------- report.html - шаблон карточки инцидента с раскрывающимеся полями
|             |           |-------- report_wa.html - шаблон карточки инцидента для генерации pdf						   
|			  |		   
|             |-------- all-incidents.json - шаблон POST запроса для получения всех не закрытых инцидентов
|    		  |-------- incident-events-detail.json - шаблон POST запроса дл получения событий и их деталей
|			  |-------- message.txt - шаблон письма с информацией об инциденте
|			  |-------- sendto.txt - список рассылки
|
|-------- incidents - папка с данными инцидентов [открытый доступ]
|             |-------- *{incident_id} - папка с данными конкретного инцидента согласно его id (генерируется при возникновении)
|			                   |-------- *incident.json - краткая информация о инциденте
|							   |-------- *incident_detail.json - детали инцидента
|							   |-------- *incident_events.json - связанные с инцидентом события
|							   |-------- *incident_events_detail.json - детали связанных событий
|							   |-------- *report.html - отчет в формате html со скрывающимеся полями
|							   |-------- *report.pdf - отчет в pdf, сгенерированный на базе report_wa.html
|							   |-------- *report_wa.html - отчет в формате html все поля развернуты
|	
|--------- reports - папка со списком инцидентов [открытый доступ]
|             |--------- *index.html - список всех возникших с момента начала работы инцидентов
|             |--------- style.css - таблица стилей для списка
|			  |--------- script.js - необходимые js скрипты для списка
|             |--------- logo.png - логотип компании
|
|		
|-------- MPSIA.py - основной исполняемый файл, содержит все необходимые настройки подключения. [доступ должен быть ограничен]
|-------- MPSNewIncidentAlert.py - основной модуль, производит авторизацию, сбор данных об инцидентахи событиях. [доступ должен быть ограничен]
|-------- MPSEmailSender.py - модуль отправки сообщений об инцидентах согласно списку рассылки. [доступ должен быть ограничен]
|-------- MPSAClear.py - очистка баз данных и установка времени обновления на текущее (рекомендуется выполнить при первом запуске) [доступ должен быть ограничен]
|-------- log.txt - файл с логами выполнения программы [доступ должен быть ограничен]
|-------- .last-update-unix-time - (скрытый файл) дата последней проверки [доступ должен быть ограничен]
|-------- .indexDB - база данных со списком инцидентов [доступ должен быть ограничен]
|-------- .indexDB_data - база данных со списком и деталями инцидентов [доступ должен быть ограничен]


1) Настройка подключения и авторизации

файл /MPSIA.py

Необходимо запонить константы

SIEM_DOMAIN = "https://SIEM.local.com" # в случае, если необходимо указать порт, в конце указывается :port_number, https://SIEM.local.com:4433
SIEM_USER = "alert_bot"
SIEM_USER_PASSWORD = "alert_bot_password"
SERVER_ADDR = "https://this_is_local_address_of_this_server.ru" # адрес сервера, на котором будет запускаться бот. Если на локальном, то localhost.

2) Добавление в список рассылки отчетов

файл /templates/sendto.txt

Пример:

Имя1 Фамилия1 mymail1@email.com
Имя2 Фамилия2 mymail2@email.com

3) Редактирование шаблона сообщения

файл /templates/message.txt

Пример:

Добрый день, ${PERSON_NAME}.

В SIEM возник новый инцидент, в приложении карточка в формате pdf.

Доступ к карточке так же можно получить через внутренний портал:
${PORTAL_ADDR}
Прямая ссылка на данный инцидент: 
${PORTAL_INC}

Данное письмо отправлено автоматически, не нужно на него отвечать.

С уважением.
Mail Bot.

На данный момент доступны только данные константы: PERSON_NAME, PORTAL_ADDR, PORTAL_INC.





